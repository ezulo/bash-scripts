#!/usr/bin/env bash

#
# A script for running a floating terminal, with a single command.
# Uses a persistent kitty daemon via remote control for fast startup.
#

set -e

_ID="floating-term"
SOCKET_DIR="/run/user/$(id -u)"
SOCKET=""

__find_socket() {
    local sock
    for sock in "$SOCKET_DIR"/kitty-floating.sock-*; do
        [[ -S "$sock" ]] && SOCKET="$sock" && return 0
    done
    return 1
}

__ensure_daemon() {
    if __find_socket && kitten @ --to "unix:$SOCKET" ls >/dev/null 2>&1; then
        return 0
    fi
    systemctl --user start kitty-floating.service
    # Wait for socket to be ready
    for _ in {1..20}; do
        if __find_socket && kitten @ --to "unix:$SOCKET" ls >/dev/null 2>&1; then
            return 0
        fi
        sleep 0.05
    done
    echo "Failed to start kitty-floating daemon" >&2
    return 1
}

__term_close_all() {
    # Close existing floating-term windows (but not the daemon)
    kitten @ --to "unix:$SOCKET" close-window --match 'title:^(?!kitty-floating-daemon)' 2>/dev/null || true
}

__term_spawn() {
    local WINDOW_TITLE=""
    local WINDOW_CLASS="${_ID}"

    while [[ -n "$1" ]]; do
        [[ "$1" == "--" ]] && shift && break
        case "$1" in
            '--class='*) WINDOW_CLASS="${1#*=}" ;;
            '--title='*) WINDOW_TITLE="${1#*=}" ;;
            '--size='*)  WINDOW_CLASS="$_ID-${1#*=}" ;;
        esac
        shift
    done

    WINDOW_TITLE="${WINDOW_TITLE:-$*}"

    __ensure_daemon
    __term_close_all

    kitten @ --to "unix:$SOCKET" launch \
        --type=os-window \
        --title "$WINDOW_TITLE" \
        --os-window-class "$WINDOW_CLASS" \
        -- sh -c "$*"
}

__term_spawn "$@"
